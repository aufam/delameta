stages:
  - build-amd64
  - build-arm64
  - build-arm32

build-amd64:
  stage: build-amd64
  only:
    - /^release\/.*/
  image: debian@sha256:00558f781b91e90469812bad32002f311ab26ef241b4a1996f6600680ec82f5c
  before_script:
    - apt update && apt upgrade
    - apt install -y --no-install-recommends \
        g++ \
        build-essential \
        ninja-build \
        cmake \
        git \
        ca-certificates \
        libssl-dev
  script:
    - mkdir -p build
    - cmake -B build \
      -G Ninja \
      -DDELAMETA_BUILD_APP=ON \
      -DDELAMETA_BUILD_TEST=ON \
      -DDELAMETA_CXX_STANDARD=20 \
      -DCMAKE_BUILD_TYPE=Release
    - cmake --build build
    - ctest --test-dir build --output-on-failure
    - cmake --build build -t build-deb
  artifacts:
    paths:
      - build/*.deb

build-arm64:
  stage: build-arm64
  only:
    - /^release\/.*/
  image: arm64v8/debian:bullseye-slim
  before_script:
    - apt update && apt upgrade
    - apt install -y --no-install-recommends \
        g++ \
        build-essential \
        ninja-build \
        cmake \
        git \
        ca-certificates \
        libssl-dev
  script:
    - mkdir -p build
    - cmake -B build \
      -G Ninja \
      -DDELAMETA_BUILD_APP=ON \
      -DDELAMETA_BUILD_TEST=ON \
      -DDELAMETA_CXX_STANDARD=20 \
      -DCMAKE_BUILD_TYPE=Release
    - cmake --build build
    - ctest --test-dir build --output-on-failure
    - cmake --build build -t build-deb
  artifacts:
    paths:
      - build/*.deb

build-arm32:
  stage: build-arm32
  only:
    - /^release\/.*/
  image: arm32v8/debian:bullseye-slim
  before_script:
    - apt update && apt upgrade
    - apt install -y --no-install-recommends \
        g++ \
        build-essential \
        ninja-build \
        cmake \
        git \
        ca-certificates \
        libssl-dev
  script:
    - mkdir -p build
    - cmake -B build \
      -G Ninja \
      -DDELAMETA_BUILD_APP=ON \
      -DDELAMETA_BUILD_TEST=ON \
      -DDELAMETA_CXX_STANDARD=20 \
      -DCMAKE_BUILD_TYPE=Release
    - cmake --build build
    - ctest --test-dir build --output-on-failure
    - cmake --build build -t build-deb
  artifacts:
    paths:
      - build/*.deb

